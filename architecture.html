<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>System architecture - hevm</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">hevm</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum/hevm" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="hhttps://github.com/ethereum/hevm/edit/main/src/architecture.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="steppers--interpreters"><a class="header" href="#steppers--interpreters">Steppers &amp; Interpreters</a></h1>
<p>The core EVM semantics in hevm can be found in <code>EVM.hs</code>. EVM state is contained
in the <code>VM</code> record, and the <code>exec1</code> function executes a single opcode inside
the monad <code>type EVM a = State VM a</code>.</p>
<p>The core semantics are pure, and should information from the outside world be
required to continue execution (RPC queries or SMT queries),
execution will halt, and the <code>result</code> field of the VM will be an instance of
<code>VMFailure (Query _)</code>.</p>
<p>Multiple steps of EVM execution are orchestrated via interpreters for a meta
language. Programs in the meta language are called Steppers. The instructions
in the meta language can be found in <code>Stepper.hs</code>.</p>
<p>There can potentially be many different interpreters with different features. Currently,
we provide a concrete and a symbolic interpreter. Interpreters can
handle Queries in different ways, for example in the symbolic interpreter, both
sides of a branch point will be explored, while in the concrete interpreter,
such branching is not permitted.</p>
<p>Interpreters are parametrized by a <code>Fetcher</code> that can handle RPC and SMT
queries, and can be instantiated with fetchers that could have different
fetching strategies (e.g. caching). Interpreters execute Steppers and use their
Fetcher to handle any Queries that need to be resolved.</p>
<p>This architecture is very modular and pluggable, and allows the core semantics
to be shared between different interpreters, as well as the reuse of steppers
between different interpreters, making it easy to e.g. share the same test
execution strategy between concrete and symbolic interpreters.</p>
<pre class="mermaid">graph LR
    subgraph meta-language
    A[Stepper]
    end
    subgraph interpreters
    A --&gt; B[Concrete]
    A --&gt; C[Symbolic]
    end
    subgraph fetchers
    F[Fetch.hs]
    B --&gt; F
    C --&gt; F
    end
    subgraph EVM Semantics
    G[EVM.hs]
    B --&gt; G
    C --&gt; G
    end
</pre>
<h1 id="expr"><a class="header" href="#expr">Expr</a></h1>
<p>The symbolic execution features in hevm are built using a custom IR,
imaginatively named <code>Expr</code>. This is a summarized trace semantics of a given
EVM program.</p>
<p>One important principle is that of local context: e.g. each term representing a
read from a Buf/Storage will always contain a snapshot of the state of the
buffer/store at the time the read occurred. This ensures that all context
relevant to a given operation is contained within the term that represents that
operation, and allows subsequent analysis to be stateless.</p>
<p>Expressions in this language can have the following types:</p>
<ul>
<li><code>End</code>: control flow</li>
<li><code>Word</code>: a 256 bit word (a stack item)</li>
<li><code>Byte</code>: a single byte</li>
<li><code>Buf</code>: a byte array (used for calldata, memory and returndata)</li>
<li><code>Storage</code>: contract storage</li>
<li><code>Logs</code>: EVM logs</li>
</ul>
<h2 id="control-flow"><a class="header" href="#control-flow">Control Flow</a></h2>
<p>An EVM program is represented by an <code>Expr End</code>, which is either a single end
state for a program without branches, or a series of nested if-then-else terms,
where each leaf is an end state. Some end states (e.g. <code>Return</code>) contain copies
of any externally observable data (i.e. returndata and post call storage).</p>
<p>As an example the following Expr encodes a program that branches based on the
equality of two symbolic words ("a" and "b"), and returns if they are equal and
reverts if they are not:</p>
<pre><code class="language-haskell">(ITE (Eq (Var "a") (Var "b")) (Success ...) (Failure ...))
</code></pre>
<h2 id="buffers"><a class="header" href="#buffers">Buffers</a></h2>
<p>Memory, calldata, and returndata are all represented as a Buf. Semantically
speaking a Buf is a byte array with of size 2^256.</p>
<p>Bufs have three base constructors:</p>
<ul>
<li>AbstractBuf:    all elements are fully abstract values</li>
<li>ConcreteBuf bs: all elements past (length bs) are zero</li>
</ul>
<p>Bufs can be read from with:</p>
<ul>
<li>ReadByte idx buf: read the byte at idx from buf</li>
<li>ReadWord idx buf: read the byte at idx from buf</li>
</ul>
<p>Bufs can be written to with:</p>
<ul>
<li>WriteByte idx val buf: write val to idx in buf</li>
<li>WriteWord idx val buf: write val to idx in buf</li>
<li>CopySlice srcOffset dstOffset size src dst:
overwrite dstOffset -&gt; dstOffset + size in dst with srcOffset -&gt; srcOffset + size from src</li>
</ul>
<p>e.g. the following Buf expression represents an abi encoded call to <code>foo(uint256 a)</code>:</p>
<pre><code class="language-haskell">(WriteWord (Lit 0x4) (Var "a")
(WriteByte (Lit 0x3) (LitByte 56)
(WriteByte (Lit 0x2) (LitByte 189)
(WriteByte (Lit 0x1) (LitByte 190)
(WriteByte (Lit 0x0) (LitByte 47)
(AbstractBuf "txdata")))))
</code></pre>
<p>This represents calldata of the form:</p>
<pre><code>-----------------------------------------------------------------------
| &lt;function selector&gt; | &lt;symbolic word&gt; | arbitrary symbolic data.... |
-----------------------------------------------------------------------
</code></pre>
<p>Note that a Buf expression contains a copy of all historical writes, meaning
that it is possible to write multiple times to the same location. In this case
only the topmost write is relevant. This allows us to mix symbolic and concrete
writes to the same buffer.</p>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>Storage expressions are similar, but instead of writing regions of bytes, we
write a word to a particular key in a given addresses storage. Note that as
with a Buf, writes can be sequenced on top of concrete, empty and fully
abstract starting states.</p>
<p>As with Bufs, Storage expressions contain a full history of all previous writes.</p>
<p>For example the following expression represents a write of a symbolic word "c"
to slot 2 for the zero address followed by a write of 1 to the slot at the
symbolic location "b" for the zero address. These writes are sequenced on top
of an <code>EmptyStore</code> meaning all other storage locations are held to be 0.</p>
<pre><code class="language-haskell">(SStore (Lit 0) (Var "b") (Lit 1)
(SStore (Lit 0) (Lit 2) (Var "c")
EmptyStore))
</code></pre>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>Logs are also represented as a sequence of writes, but unlike Buf and Storage
expressions, Log writes are always sequenced on an empty starting point, and
overwriting is not allowed.</p>
<h1 id="symbolic-execution"><a class="header" href="#symbolic-execution">Symbolic Execution</a></h1>
<p>During symbolic execution all possible branches of the program are explored
symbolically. Reachability analysis is performed at this stage only if needed
for loop unrolling. This produces an Expr End. As an example consider the
following program:</p>
<pre><code class="language-solidity">contract MyContract {
  mapping(uint =&gt; uint) items;
  function test(uint val1) public {
    require(val1 &gt; 10);
    unchecked {
      items[4] = val1+1;
      assert(items[4] &gt; 10);
    }
  }
}
</code></pre>
<p>This decompiles into the following Expr End:
<img src="expr.png" alt="Body frame" /></p>
<p>For more details, see our research paper on hevm on open access
<a href="https://link.springer.com/content/pdf/10.1007/978-3-031-65627-9_22.pdf?pdf=inline+link">research
paper</a>
as presented at CAV 2024, <a href="https://github.com/msooseth/hevm-presentation/blob/main/HEVM-presentation%20CAV%2026th%20July%202024.pdf">presentation
here</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="for-hevm-developers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="for-hevm-developers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="solidity.min.js"></script>
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>



    </div>
    </body>
</html>
